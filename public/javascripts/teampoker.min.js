/*! Story Point Team Poker - A realtime web application powered by nodejs and Socket.IO.
* v2.0.0-5 - 2012-09-08
* Homepage: http://teampoker.jit.su
* Copyright (c) 2012 Wayne Ye - http://wayneye.com
* Licensed with MIT */
function SocketClient(e){this.ServerUrl=e}function WidgetBase(){this.base=WidgetBase.prototype,this.onShown=[],this.onHidden=[],this.WidgetDOM=null,this.ListenerQueue={},this.broadcastMessage=function(e,t){this.ListenerQueue[e]&&this.ListenerQueue[e].forEach(function(e){e(t)})}}function PopUp(e,t,n,r,i,s){TeamPoker.UI.WidgetBase.call(this);var o=this,u=null;this.init=function(){i=i||"modal hide fade",s=s||"static",u=$("<div>").attr("id",e).attr("class",i);var o=function(e,t){$.isArray(t)?$.each(t,function(t,n){e.append(n)}):e.append(t)},a=$("<div>").attr("class","modal-header"),f=$("<div>").attr("class","modal-body"),l=$("<div>").attr("class","modal-footer");o(a,t),o(f,n),o(l,r),u.append(a).append(f).append(l),this.WidgetDOM=u,this.base.init.call(this)},this.show=function(){this.WidgetDOM.modal({backdrop:s,keyboard:!0,show:!0}),this.WidgetDOM.on("hidden",function(){$(this).remove()}),this.WidgetDOM.on("show",function(){o.onShow.length&&o.onShow.forEach(function(e){e()})}),this.WidgetDOM.on("shown",function(){o.onShown.length&&o.onShown.forEach(function(e){e()})}),this.WidgetDOM.on("hide",function(){o.onHide.length&&o.onHide.forEach(function(e){e()})}),this.WidgetDOM.on("hidden",function(){o.onHidden.length&&o.onHidden.forEach(function(e){e()})})},this.hide=function(){this.WidgetDOM.modal("hide")},this.onShow=[],this.onShown=[],this.onHide=[],this.onHidden=[]}function LoginForm(){TeamPoker.UI.WidgetBase.call(this);var e=null;this.init=function(){var t=$("<h3>").text("Team Poker - Please input your name"),n=$("<input>").attr("type","text").attr("class","span2").attr("placeholder","Input your name here").attr("autofocus","").attr("id","txt-nickname"),r=$("<span>").attr("class","hide ipt-err").text("Nick name is required!"),i=$("<div>").attr("class","form-row").append($("<label>").attr("class","control-label").attr("for","txt-nickname").text("Nick Name")).append(n).append(r),s=$("<a>").attr("href","javascript:void(0);").attr("class","btn btn-primary").text("Join");e=new TeamPoker.UI.PopUp("loginForm",t,i,s),e.onShown.push(function(){n.focus()}),s.click(function(t){var i=n.val();if(!i){r.show();return}r.hide(),TeamPoker.login(i),e.hide()}),e.init(),e.WidgetDOM.keydown(function(e){e.keyCode==13&&s.click()})},this.show=function(){e.show()},this.hide=function(){e.hide()}}function PokerQueue(){TeamPoker.UI.WidgetBase.call(this),this.init=function(){var e=$("<div>").attr("id","pokerbar"),t=this;TeamPoker.Constants.POKER_VALUES.forEach(function(n){var r=$("<div>").attr("class","poker").attr("title",n).attr("vote-value",n).text(n).css("margin-left","-18px");r.hover(function(){$(this).addClass("activePoker"),$(this).css("z-index",100)},function(){$(this).removeClass("activePoker"),$(this).css("z-index",0)}),r.click(function(n){$(this).tooltip("hide");var r=$(this).attr("vote-value");e.hide(),t.broadcastMessage("USER-VOTE",r)}),e.append(r)}),this.WidgetDOM=e,this.base.init.call(this,$("#pokerbar-wrapper"))},this.show=function(){this.base.show.call(this),$("#pokerbar > .poker").tooltip({})}}function VoteResultDialog(e,t){TeamPoker.UI.WidgetBase.call(this);var n=null;this.init=function(){var r=[$("<h3>").text("Story point for: "),$("<span>").text(e)],i=$("<div>").attr("id","voteResultPanel"),s=$("<input>").attr("type","text").attr("class","input-mini").attr("id","txt-estimated-story-point").attr("size","2").attr("autofocus",""),o=$("<span>").attr("class","hide ipt-err").text("Invalid story point!"),u=$("<div>").attr("id","estimated-story-point-wrapper").append($("<span>").text("Estimated Point: ")).append(s).append(o),a=$("<a>").attr("href","javascript:void(0);").attr("class","btn").attr("data-dismiss","modal").text("Re-vote"),f=$("<a>").attr("href","javascript:void(0);").attr("class","btn btn-primary").attr("data-dismiss","modal").text("Save Point To Story"),l=[u,a,f],c=this;n=new TeamPoker.UI.PopUp("vote-result-dialog",r,i,l),n.init(),n.onShown.push(function(){var e=function(e){e.css("opacity",1),e.css("webkitTransform","rotateY(360deg)"),e.css("-moz-Transform","rotateY(360deg)")},n=[];_(t).each(function(e){var t=e.VoterName,r=e.VoteVal,s=$('<div class="votedPoker resultPoker"><div class="poker">'+r+"</div><span>"+t+"</span></div>");s.bind("transitionend webkitTransitionEnd",function(){e.HighScore&&($(this).addClass("highscore"),$(this).css("margin-top","10px")),e.LowScore&&($(this).addClass("lowscore"),$(this).css("margin-top","30px")),e.SpecialScore&&$(this).addClass("specialscore")}),i.append(s),n.push(s)}),_(n).each(function(t){setTimeout(function(){e(t)},100)})}),s.on("keyup",function(){$.inArray($(this).val(),TeamPoker.Constants.POKER_VALUES)===-1?o.show():o.hide()}),a.click(function(e){c.broadcastMessage("RE-VOTE")}),f.click(function(e){var t=$.trim(s.val());t!==""&&$.inArray(t,TeamPoker.Constants.POKER_VALUES)>=0?c.broadcastMessage("SAVE-POINT",t):(o.show(),e.preventDefault())})},this.show=function(){n.show()},this.hide=function(){n.hide()}}var TeamPoker=TeamPoker||{};TeamPoker.UI=TeamPoker.UI||{},"localStorage"in window&&window.localStorage!==null&&(Storage.prototype.setObject=function(e,t){this.setItem(e,JSON.stringify(t))},Storage.prototype.getObject=function(e){return this.getItem(e)&&JSON.parse(this.getItem(e))}),TeamPoker.Constants={POKER_VALUES:["0","0.5","1","2","3","5","8","13","20","40","100","?"]},SocketClient.prototype={Listeners:{},ServerUrl:"",connect:function(){var e={"sync disconnect on unload":!1};this.socket=io.connect(this.ServerUrl,e);var t=this,n=location.pathname.substring(1);console.log('Connected to Socket server, namespace: "'+n+'".'),this.socket.on(n,function(e){console.log("Client received message: "),console.log(e),t.Listeners[e.MsgType]&&t.Listeners[e.MsgType].length&&_(t.Listeners[e.MsgType]).each(function(t){t(e.Data)})})},sendMsg:function(e,t){this.socket.emit(e,t)},addListener:function(e,t){this.Listeners[e]=this.Listeners[e]||[],this.Listeners[e].push(t)}},TeamPoker.SocketClient=new SocketClient([location.protocol,"//",location.host].join("")),TeamPoker.SocketClient.connect(),WidgetBase.prototype={constructor:WidgetBase,init:function(e){e=e||$(window),this.WidgetDOM&&e.append(this.WidgetDOM)},show:function(){if(!this.WidgetDOM)throw new Error("Cannot show this widget without seting WidgetDOM!");this.WidgetDOM.show(),this.onShown.length&&this.onShown.forEach(function(e){e()})},hide:function(){if(!this.WidgetDOM)throw new Error("Cannot show this widget without seting WidgetDOM!");this.WidgetDOM.hide(),this.onHidden.length&&this.onHidden.forEach(function(e){e()})}},TeamPoker.UI.WidgetBase=WidgetBase,PopUp.prototype=Object.create(TeamPoker.UI.WidgetBase.prototype),TeamPoker.UI.PopUp=PopUp,LoginForm.prototype=Object.create(TeamPoker.UI.WidgetBase.prototype),TeamPoker.UI.LoginForm=LoginForm,PokerQueue.prototype=Object.create(TeamPoker.UI.WidgetBase.prototype),TeamPoker.UI.PokerQueue=PokerQueue,TeamPoker.UIManager={ParticipantsList:$("#participants"),StoryPointer:null,PokerQueue:null,VoteResultDialog:null,IsCreatingRoom:location.pathname==="/",init:function(){$("#btn-logout").click(function(e){e.preventDefault(),TeamPoker.logout(),location.reload()});if($.cookie("LoginName"))TeamPoker.login($.cookie("LoginName"));else{var e=new TeamPoker.UI.LoginForm;e.init(),e.show()}$("#btnViewResult").click(TeamPoker.viewVoteResult),this.PokerQueue=new TeamPoker.UI.PokerQueue,this.PokerQueue.init(),this.PokerQueue.ListenerQueue["USER-VOTE"]=[function(e){$("#vote-status #spVoteVal").text(e),$("#vote-status").show(),TeamPoker.vote(e)}],this.PokerQueue.show()},loadRoomInfo:function(e){this.initStoryTable(e),this.refreshParticipantsList(e.ParticipantCollection)},initStoryTable:function(e){_(e.StoryCollection).each(function(e,t){TeamPoker.UIManager.addStoryRow({Id:t,Title:e.Title,Point:e.Point})}),e.CurrentVotingStory?(TeamPoker.CurrentVotingStory=e.CurrentVotingStory,this.setStoryPointer(e.CurrentVotingStory)):this.setStoryPointer(parseInt($("#story-table > tbody > tr:first").attr("story-id"))),$("#btn-add-story").click(function(){TeamPoker.UIManager.addStoryRow()})},setStoryPointer:function(e){TeamPoker.CurrentVotingStory=e,this.StoryPointer&&this.StoryPointer.remove();var t=$("<div>").attr("id","pointer").attr("class","label label-info").attr("draggable","true").text(" ← ");t[0].addEventListener("dragstart",function(e){e.dataTransfer.effectAllowed="move"}),this.StoryPointer=t,$("#story-table > tbody > tr[story-id="+e+"] > td:eq(2)").append(t)},addStoryRow:function(e){var t=document.getElementById("story-table").tBodies[0],n=t.insertRow(0),r=$(n.insertCell(0)),i=$(n.insertCell(1)),s=$(n.insertCell(2));if(e)r.html(e.Title),e.Point&&i.html(e.Point),$(n).attr("story-id",e.Id);else{var o=$("#story-table > tbody > tr:last").attr("story-id")||0;$(n).attr("story-id",parseInt(o)+1),o===0&&this.setStoryPointer($(n.cells[2]))}t.appendChild(n),this.bindEventForStoryRow(n),e||$(n.cells[0]).click()},bindEventForStoryRow:function(e){$([e.cells[0],e.cells[1]]).on("click",TeamPoker.UIManager.changeStoryContent),$([e.cells[0],e.cells[1]]).on("mouseover",function(){$(this).tooltip({title:"Click to edit"})}),$(e.cells[2]).popover({title:"Currently Voting",content:"Drag the arrow up/down to target the story which is currently voting for."}),this.makeCellDraggable(e.cells[2])},makeCellDraggable:function(e){e.addEventListener("dragover",function(e){e.preventDefault(),e.dataTransfer.dropEffect="move",$(this).addClass("dragover")}),e.addEventListener("dragleave",function(e){$(this).removeClass("dragover")}),e.addEventListener("drop",function(e){$(this).removeClass("dragover"),$(this).append(TeamPoker.UIManager.StoryPointer),TeamPoker.setCurrentStory(parseInt($(this).parent().attr("story-id")))})},changeStoryContent:function(e){var t=$(this),n=parseInt($(this).parent().attr("story-id")),r=$(this).html(),i=$("<input>").attr("type","text").val($(this).text());$(this).tooltip("hide"),t.off("click"),i.on("blur",function(e){var i=$(this).val();if(i!==r){var s="";this.parentElement.cellIndex===0?TeamPoker.updateStoryInfo(n,{Title:i}):this.parentElement.cellIndex===1&&TeamPoker.updateStoryInfo(n,{Point:i})}t.html($(this).val()),t.on("click",TeamPoker.UIManager.changeStoryContent)}),t.html(""),t.append(i),i.focus()},updateStoryInfo:function(e){$("#story-table > tbody > tr[story-id="+e.Id+"]").length?"Title"in e.Val?$("#story-table > tbody > tr[story-id="+e.Id+"] > td:eq(0)").html(e.Val.Title):"Point"in e.Val&&$("#story-table > tbody > tr[story-id="+e.Id+"] > td:eq(1)").html(e.Val.Point):this.addStoryRow({Id:e.Id,Title:e.Val.Title,Point:e.Val.Point})},refreshParticipantsList:function(e){TeamPoker.UIManager.ParticipantsList.html(""),_(e).each(function(e,t){var n=$("<span>").attr("class","participaint label label-inverse").attr("id",t).text(e);TeamPoker.UIManager.ParticipantsList.append(n)})},removeFromParticipantsList:function(e){TeamPoker.UIManager.ParticipantsList.find("span[id="+e+"]").remove()},showPokerbar:function(){$("#vote-status").hide(),this.PokerQueue.show()},displayVoteResult:function(e){console.log("Displaying vote result: "),console.log(e);var t=$("#story-table > tbody > tr[story-id="+TeamPoker.CurrentVotingStory+"] > td:eq(0)").html();this.VoteResultDialog=new TeamPoker.UI.VoteResultDialog(t,e),this.VoteResultDialog.init(),this.VoteResultDialog.ListenerQueue["RE-VOTE"]=[function(){TeamPoker.UIManager.updateStoryInfo({Id:TeamPoker.CurrentVotingStory,Val:{Point:""}}),TeamPoker.UIManager.showPokerbar(),TeamPoker.reVote()}],this.VoteResultDialog.ListenerQueue["SAVE-POINT"]=[function(e){TeamPoker.UIManager.updateStoryInfo({Id:TeamPoker.CurrentVotingStory,Val:{Point:e}}),TeamPoker.savePoint(e)}],this.VoteResultDialog.show()},revoteForStory:function(e){this.updateStoryInfo({Id:e,Val:{Point:""}}),this.showPokerbar(),this.VoteResultDialog&&this.VoteResultDialog.hide()},savePointForStory:function(e,t){this.updateStoryInfo({Id:e,Val:{Point:t}}),this.VoteResultDialog&&this.VoteResultDialog.hide()},cleanUp:function(){sessionStorage.clear()}},$(document).ready(function(){TeamPoker.UIManager.init()}),$(window).on("beforeunload",function(){return"You are about to leave Team Poker..."}),$(window).unload(function(){TeamPoker.logout(),TeamPoker.UIManager.cleanUp()}),VoteResultDialog.prototype=Object.create(TeamPoker.UI.WidgetBase.prototype),TeamPoker.UI.VoteResultDialog=VoteResultDialog,TeamPoker.CurrentVoterName="",TeamPoker.CurrentVoterId=0,TeamPoker.CurrentVotingStory=0,TeamPoker.MessageType={LoginCallback:"LoginCallback",NewParticipant:"NewParticipant",LeaveParticipant:"LeaveParticipant",SetCurrentStory:"SetCurrentStory",UpdateStoryInfo:"UpdateStoryInfo",ViewVoteResult:"ViewVoteResult",Revote:"Revote",SavePoint:"SavePoint",GameStatus:"GameStatus"},TeamPoker.login=function(e){TeamPoker.SocketClient.sendMsg("login_event",e)},TeamPoker.loginCallback=function(e){e.Success==="true"?(TeamPoker.CurrentVoterId=e.ParticipantInfo.Id,TeamPoker.CurrentVoterName=e.ParticipantInfo.Name,TeamPoker.UIManager.loadRoomInfo(e.RoomInfo),sessionStorage.setObject("RoomInfo",e.RoomInfo)):alert("Login failed! Please try again:)")},TeamPoker.logout=function(){$.removeCookie("LoginName"),TeamPoker.SocketClient.sendMsg("logout_event",TeamPoker.CurrentVoterId)},TeamPoker.logoutCallback=function(e){TeamPoker.UIManager.removeFromParticipantsList(e.Id)},TeamPoker.newParticipantCallback=function(e){TeamPoker.UIManager.refreshParticipantsList(e.ParticipantCollection)},TeamPoker.leaveParticipantCallback=function(e){TeamPoker.UIManager.refreshParticipantsList(e.ParticipantCollection)},TeamPoker.setCurrentStory=function(e){TeamPoker.CurrentVotingStory=e,TeamPoker.SocketClient.sendMsg("set_current_story_event",e)},TeamPoker.setCurrentStoryCallback=function(e){TeamPoker.UIManager.setStoryPointer(e.StoryId)},TeamPoker.updateStoryInfo=function(e,t){TeamPoker.SocketClient.sendMsg("update_story_event",{Id:e,Val:t})},TeamPoker.updateStoryInfoCallback=function(e){TeamPoker.UIManager.updateStoryInfo(e.StoryInfo)},TeamPoker.vote=function(e){TeamPoker.SocketClient.sendMsg("vote_event",{StoryId:TeamPoker.CurrentVotingStory,VoterName:TeamPoker.CurrentVoterName,VoteVal:e})},TeamPoker.viewVoteResult=function(e){TeamPoker.SocketClient.sendMsg("view_vote_result_event",TeamPoker.CurrentVotingStory)},TeamPoker.viewVoteResultCallback=function(e){_(e.VoteStatus).each(function(e){e.VoteVal==="?"||e.VoteVal==="0"?e.SpecialScore=!0:e.VoteVal=parseFloat(e.VoteVal)});var t=_.chain(e.VoteStatus).pluck("VoteVal").without("?","0").sort(function(e,t){return e-t}).uniq();t.value().length>2&&_(e.VoteStatus).each(function(e){e.VoteVal===t.first().value()&&(e.LowScore=!0),e.VoteVal===t.last().value()&&(e.HighScore=!0)}),TeamPoker.UIManager.displayVoteResult(e.VoteStatus)},TeamPoker.reVote=function(){TeamPoker.SocketClient.sendMsg("revote_event",TeamPoker.CurrentVotingStory)},TeamPoker.reVoteCallback=function(e){TeamPoker.UIManager.revoteForStory(e.Id)},TeamPoker.savePoint=function(e){TeamPoker.SocketClient.sendMsg("save_point_event",{Id:TeamPoker.CurrentVotingStory,Point:e})},TeamPoker.savePointCallback=function(e){TeamPoker.UIManager.savePointForStory(e.Id,e.Point)},TeamPoker.SocketClient.addListener(TeamPoker.MessageType.LoginCallback,TeamPoker.loginCallback),TeamPoker.SocketClient.addListener(TeamPoker.MessageType.GameStatus,TeamPoker.onLoadGameStatus),TeamPoker.SocketClient.addListener(TeamPoker.MessageType.NewParticipant,TeamPoker.newParticipantCallback),TeamPoker.SocketClient.addListener(TeamPoker.MessageType.LeaveParticipant,TeamPoker.logoutCallback),TeamPoker.SocketClient.addListener(TeamPoker.MessageType.SetCurrentStory,TeamPoker.setCurrentStoryCallback),TeamPoker.SocketClient.addListener(TeamPoker.MessageType.UpdateStoryInfo,TeamPoker.updateStoryInfoCallback),TeamPoker.SocketClient.addListener(TeamPoker.MessageType.ViewVoteResult,TeamPoker.viewVoteResultCallback),TeamPoker.SocketClient.addListener(TeamPoker.MessageType.Revote,TeamPoker.reVoteCallback),TeamPoker.SocketClient.addListener(TeamPoker.MessageType.SavePoint,TeamPoker.savePointCallback);